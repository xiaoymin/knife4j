---
id: knife4j-gateway-introduce
title: Spring Cloud Gatewayç½‘å…³ä¸‹çš„æ–‡æ¡£èšåˆ?å°±ç”¨å®ƒäº†
description: Spring Cloud Gatewayç½‘å…³ä¸‹çš„æ–‡æ¡£èšåˆ?å°±ç”¨å®ƒäº†
keywords:
- knife4j
- Spring Cloud Gatewayç½‘å…³èšåˆæ–‡æ¡£
- swaggerèšåˆ
- Knife4jèšåˆ
- æ–‡æ¡£èšåˆ
- å¾®æœåŠ¡èšåˆæ–‡æ¡£
sidebar_position: 4
author: å…«ä¸€èœåˆ€
data: 2023å¹´8æœˆ13æ—¥
---

å¤§å®¶å¥½ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯ä»‹ç»åˆ†äº«Knife4j-gatewayç½‘å…³èšåˆæ–‡æ¡£ç»„ä»¶,è‡ª4.0ç‰ˆæœ¬å‘å¸ƒè¯¥ç»„ä»¶åï¼Œå¾—åˆ°äº†å¤§å®¶çš„ç§¯æå“åº”ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯ç§¯æå“åº”ç”¨æˆ·çš„éœ€æ±‚ï¼ŒæŒç»­è¿­ä»£ä¼˜åŒ–

è¯¥ç»„ä»¶æ˜¯ä¸€ä¸ªéå¸¸è½»é‡çº§çš„ç½‘å…³èšåˆç»„ä»¶ï¼Œé€‚ç”¨äºå¼€å‘è€…ä½¿ç”¨Spring Cloud Gatewayç½‘å…³ç»„ä»¶è¿›è¡ŒSwagger2ã€OpenAPI3è§„èŒƒçš„æ–‡æ¡£èšåˆ

## ğŸŒ¾ 1.å‰è¨€

åœ¨è€ƒè™‘å†™è¿™ä¸ªç»„ä»¶ä¹‹å‰ï¼Œå¼€å‘è€…åœ¨Spring Cloud Gatewayç½‘å…³ç»„ä»¶ä¸‹è¿›è¡Œèšåˆ`Swagger2`/`OpenAPI3`å¯èƒ½å­˜åœ¨å„ç§å„æ ·çš„é—®é¢˜

æˆ‘è®¤ä¸ºä¸»è¦åŒ…æ‹¬ï¼š

- é€‚é…ä¸åŒçš„Spring Cloud Gatewayç‰ˆæœ¬ï¼Œæ²¡æœ‰å½¢æˆç»Ÿä¸€ç¨³å®šçš„æŠ€æœ¯è§£å†³æ–¹æ¡ˆ
- Gatewayç»„ä»¶ä¸‹Webfluxå¼‚æ­¥ç¼–ç çš„é£æ ¼ï¼Œå­¦ä¹ æˆæœ¬å¼‚å¸¸é™¡å³­ï¼Œåˆå­¦è€…ä¸€æ—¶ä¹‹é—´éš¾ä»¥æŒæ¡å¾®æœåŠ¡ä½“ç³»
- èšåˆæ–‡æ¡£ä»£ç å¼ºè€¦åˆä¸šåŠ¡ä»£ç ï¼Œæ— æ³•çµæ´»é…ç½®
- æ–‡æ¡£Uiæ— æ³•éšå¿ƒæ‰€æ¬²çš„é…ç½®
- å„ç§404æˆ–è·¯å¾„é”™è¯¯ç­‰é—®é¢˜
- ç­‰ç­‰.....

## ğŸ”¥ 2.è§£å†³æ–¹æ¡ˆ 

æˆ‘ä»¬ä»å¼€å‘è€…çš„å®é™…éœ€æ±‚å‡ºå‘ï¼Œç»“åˆKnife4jå¤šå¹´å¼€æºä»¥æ¥ç§¯ç´¯çš„å®è´µç»éªŒï¼Œå†³å®šäº†æˆ‘ä»¬éœ€è¦å¼€å‘ä¸€ä¸ªGatewayç½‘å…³ä¸‹çš„èšåˆç»„ä»¶

å°†å¼€å‘è€…çš„éœ€æ±‚ã€é—®é¢˜èšåˆåœ¨ä¸€èµ·ï¼Œä¼—äººæ‹¾è–ªç«ç„°é«˜ï¼Œå½¢æˆä¸€ä¸ªç»Ÿä¸€çš„æŠ€æœ¯è§£å†³æ–¹æ¡ˆ

[knife4j-gateway](/docs/middleware-sources/spring-cloud-gateway/spring-gateway-introduction)ç»„ä»¶å°±æ˜¯åœ¨è¿™æ ·çš„åœºæ™¯ä¸‹è¯ç”Ÿçš„

è¯¥ç»„ä»¶ä¸»è¦çš„ç‰¹ç‚¹ï¼š

- âœ… **ä½¿ç”¨ç®€å•(æœ€ä½4è¡Œé…ç½®æå®šèšåˆ)ï¼Œå­¦ä¹ æˆæœ¬ä½**
- âœ… **è§£è€¦Spring Cloud Gatewayç½‘å…³ç»„ä»¶ï¼Œèšç„¦æ–‡æ¡£èšåˆåŠŸèƒ½ï¼ŒèŒè´£å•ä¸€**
- âœ… **æä¾›æ‰‹åŠ¨é…ç½®ã€å¾®æœåŠ¡è‡ªåŠ¨å‘ç°ä¸¤ç§çµæ´»é…ç½®æ–¹å¼èšåˆå­æœåŠ¡æ–‡æ¡£**
- âœ… **å¯ä»¥åŒæ—¶èšåˆSwagger2ã€OpenAPI3ä¸¤ç§ä¸åŒçš„è§„èŒƒ**
- âœ… **çµæ´»é…ç½®èšåˆè§„åˆ™ï¼Œè‡ªå®šä¹‰æ’é™¤è§„åˆ™æ”¯æŒ**
- âœ… **å¾®æœåŠ¡åœºæ™¯ä¸‹æ”¯æŒæœåŠ¡çš„ä¸Šçº¿ã€ä¸‹çº¿åœºæ™¯ï¼Œæ–‡æ¡£çŠ¶æ€ä¸å­æœåŠ¡ä¿æŒä¸€è‡´ï¼Œæ— éœ€é‡å¯æœåŠ¡**



## ğŸŒš 3.æ·±å…¥äº†è§£

æˆ‘ä»¬ç»“åˆknife4j-gatewayç»„ä»¶çš„ç‰¹ç‚¹æ¥æ·±å…¥åˆ†æï¼Œå¸¦ç€ç–‘æƒ‘æ¥ä¸€æ­¥æ­¥æ­å¼€å¥¹çš„ç¥ç§˜é¢çº±~ï¼

### âœ… **3.1 ä½¿ç”¨ç®€å•(æœ€ä½4è¡Œé…ç½®æå®šèšåˆ)ï¼Œå­¦ä¹ æˆæœ¬ä½**

é¦–å…ˆï¼Œæˆ‘ä»¬æ—¢ç„¶éƒ½å·²ç»å°è£…æˆç»„ä»¶äº†ï¼Œé‚£ä¹ˆå­¦ä¹ å’Œä½¿ç”¨æˆæœ¬æ˜¯æˆ‘ä»¬é¦–å…ˆå°±éœ€è¦è€ƒè™‘çš„äº‹æƒ…ï¼Œéœ€è¦æŠŠå¤æ‚ï¼Œéš¾å¤„ç†çš„ä¸šåŠ¡é€»è¾‘ã€æŠ€æœ¯ç»†èŠ‚ï¼Œå…¨éƒ¨å°è£…åœ¨ç»„ä»¶é‡Œï¼Œè€Œå¯¹äºä¸Šå±‚ç”¨æˆ·ï¼Œæˆ‘ä»¬æä¾›ç®€åŒ–åçš„é…ç½®ï¼Œå¼€å‘è€…åªéœ€è¦å¼€ç®±å³ç”¨å³å¯

è¿™æ˜¯ç»„ä»¶çš„ä»·å€¼ï¼Œå‰©ä¸‹å­¦ä¹ æ—¶é—´æˆæœ¬ã€‚

å½“ç„¶æˆ‘è¯´ä½¿ç”¨ç®€å•(æœ€ä½4è¡Œé…ç½®æå®šèšåˆ)ï¼Œè¿™åªæ˜¯æœ‰ç‚¹å®£ä¼ å¹ç‰›çš„å£å»ï¼Œå¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œæˆ‘åˆè¦å­¦ä¹ äº†è§£ä½ è¿™ä¸ª`knife4j-gateway`ç»„ä»¶çš„å››è¡Œé…ç½®ï¼Œé‚£ä¹Ÿæ˜¯å­¦ä¹ æˆæœ¬å•Š

è¿™ä¸ªæˆ‘æ— ä»åé©³~~~ğŸ˜‚

å¦‚æœå¼€å‘è€…çš„é¡¹ç›®ã€äº§å“é‡‡ç”¨Spring Cloudå¾®æœåŠ¡ä½“ç³»ï¼Œç½‘å…³ç»„ä»¶ä½¿ç”¨Spring Cloud Gatewayï¼Œé‚£ä¹ˆå¯¹äºSwaggerã€OpenAPI3çš„æ–‡æ¡£èšåˆï¼Œé‡‡ç”¨`knife4j-gateway`ç»„ä»¶çš„è¯ï¼Œå°±å¯ä»¥ä½¿ç”¨ç»„ä»¶çš„`discover`è‡ªåŠ¨å‘ç°æ¨¡å¼ï¼Œå®ç°è‡ªåŠ¨èšåˆ


åœ¨é¡¹ç›®ä¸­çš„`application.yml`é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œå¦‚ä¸‹é…ç½®ï¼Œå°±æå®šäº†ï¼Œé…ç½®å¦‚ä¸‹ï¼š

```yaml
knife4j:
  gateway:
    # â‘  ç¬¬ä¸€ä¸ªé…ç½®ï¼Œå¼€å¯gatewayèšåˆç»„ä»¶
    enabled: true
    # â‘¡ ç¬¬äºŒè¡Œé…ç½®ï¼Œè®¾ç½®èšåˆæ¨¡å¼é‡‡ç”¨discoveræœåŠ¡å‘ç°çš„æ¨¡å¼
    strategy: discover
    discover:
      # â‘¢ ç¬¬ä¸‰è¡Œé…ç½®ï¼Œå¼€å¯discoveræ¨¡å¼
      enabled: true
      # â‘£ ç¬¬å››è¡Œé…ç½®ï¼Œèšåˆå­æœåŠ¡å…¨éƒ¨ä¸ºSwagger2è§„èŒƒçš„æ–‡æ¡£
      version: swagger2

```

æˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨å¹¿å‘Šæ³•ç¦æ­¢çš„`æœ€ç®€å•`ã€`éå¸¸ç®€å•`ç­‰å®£ä¼ å£å»è¿›è¡Œå®£ä¼ 

æ‘¸ç€è‰¯å¿ƒå»çœ‹è¿™ä¸ªé…ç½®ï¼Œç”¨`disocver`æ¨¡å¼è¿›è¡Œèšåˆï¼Œå››è¡Œé…ç½®è¾¾åˆ°å¼€å‘è€…çš„ç›®çš„ï¼Œ**ç¡®å®**å¾ˆæ–¹ä¾¿å•Šï¼Œå­¦ä¹ æˆæœ¬ä½~~~!


### âœ… 3.2 è§£è€¦Spring Cloud Gatewayç½‘å…³ç»„ä»¶ï¼Œèšç„¦æ–‡æ¡£èšåˆåŠŸèƒ½ï¼ŒèŒè´£å•ä¸€

ä¸ºä»€ä¹ˆæˆ‘è¯´è§£è€¦å‘¢ï¼Ÿå› ä¸ºæ–‡æ¡£åŠŸèƒ½å…¶å®æ˜¯ä¸€ä¸ªå¼€å‘é˜¶æ®µçš„éœ€æ±‚ï¼Œæ˜¯å¼€å‘å›¢é˜Ÿåœ¨é…åˆå®Œæˆé¡¹ç›®ã€äº§å“è¿‡ç¨‹ä¸­ï¼Œå›¢é˜Ÿä¹‹å‰æå‡æ•ˆç‡çš„ä¸€ä¸ªæ½œåœ¨çš„éœ€æ±‚åœºæ™¯

å½“æˆ‘ä»¬çš„é¡¹ç›®ã€äº§å“å¼€å‘å®Œæˆï¼Œä¸Šçº¿åˆ°ç”Ÿäº§ç¯å¢ƒçš„æ—¶å€™ï¼Œæˆ–è€…åœ¨ä¸åŒçš„é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¼€å‘è€…çš„éœ€æ±‚åˆæ¶Œç°å‡ºæ¥äº†ï¼Œä¾‹å¦‚ï¼š

- æ¥å£è§„èŒƒæ˜¯éå¸¸é‡è¦çš„å†…éƒ¨ä¿¡æ¯ï¼Œç”Ÿäº§ç¯å¢ƒåº”è¯¥å±è”½
  > è¯·å‚è€ƒæ–‡ç« [ç”Ÿäº§ç¯å¢ƒå¦‚ä½•å±è”½Knife4jã€Swaggerç­‰Uièµ„æºå’Œæ¥å£](/docs/blog/production-forbidden-ui)
- èšåˆä»£ç åœ¨ä¸åŒçš„é¡¹ç›®ä¸­æ¥å›Copy
- å‡çº§Gatewayç»„ä»¶å¯¼è‡´èšåˆä»£ç å¤±æ•ˆï¼Œè°ƒè¯•ä¸åŒçš„Gatewayç‰ˆæœ¬ï¼Œåœ¨çº¿æœç´¢è§£å†³æ–¹æ¡ˆ
- ....

è¿˜æœ‰ä¸€äº›å…¶ä»–çš„éœ€æ±‚åœºæ™¯ï¼Œä¸€çº¿å¼€å‘è€…å¯ä»¥è‡ªè¡Œè„‘è¡¥ï¼Œä¸Šé¢è¯´åˆ—çš„éœ€æ±‚ï¼Œä½ æ˜¯å¦åœ¨å¼€å‘åœºæ™¯ä¸­ä¹Ÿç¢°åˆ°äº†å‘¢ï¼Ÿ


æ—¢ç„¶æ–‡æ¡£èšåˆåŠŸèƒ½å’Œé¡¹ç›®ã€äº§å“æœ¬èº«å¹¶æ²¡æœ‰å¤ªå¤§çš„å…³ç³»ï¼Œæ˜¯å¼€å‘è€…å¼€å‘è¿‡ç¨‹ä¸­æé«˜æ•ˆç‡çš„äº§ç‰©ï¼Œé‚£ä¹ˆå¯¹äºç»Ÿä¸€çš„äº‹æƒ…ï¼Œæˆ‘ä»¬åº”è¯¥é¿å…é‡å¤æ“ä½œï¼Œç”¨ç‹¬ç«‹çš„ä¸­é—´ä»¶æ¥è§£å†³è¿™äº›é—®é¢˜

[knife4j-gateway](/docs/middleware-sources/spring-cloud-gateway/spring-gateway-introduction)ç»„ä»¶**èšç„¦Swagger2/OpenAPI3è§„èŒƒçš„æ–‡æ¡£èšåˆ**,ä¸€æ—¦å›¢é˜Ÿä¹‹é—´ç¡®å®šä½¿ç”¨Swagger2/OpenAPI3è§„èŒƒï¼Œå¹¶ä¸”æœ‰èšåˆçš„éœ€æ±‚åœºæ™¯ï¼Œé‚£ä¹ˆå¼•å…¥ä¸€ä¸ªjarç»„ä»¶å°±èƒ½è§£å†³çš„äº‹æƒ…ï¼Œä½•ä¹è€Œä¸ä¸ºå‘¢ï¼Ÿ


### âœ… **3.3 æä¾›æ‰‹åŠ¨é…ç½®ã€å¾®æœåŠ¡è‡ªåŠ¨å‘ç°ä¸¤ç§çµæ´»é…ç½®æ–¹å¼èšåˆå­æœåŠ¡æ–‡æ¡£**

ä¸Šé¢æˆ‘ä»¬ä»å­¦ä¹ æˆæœ¬ã€è§£è€¦ä¸¤ä¸ªæ–¹é¢é˜è¿°äº†è¯¥ç»„ä»¶çš„ä»·å€¼ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œå½“æˆ‘ä»¬æ·±å…¥å»æ¢ç´¢ç½‘å…³ç»„ä»¶çš„ä¸‹çš„èšåˆåœºæ™¯æ—¶ï¼Œç«™åœ¨ä¸­é—´ä»¶ç»„ä»¶çš„ç«‹åœºä¸‹ï¼Œæˆ‘ä»¬å°±éœ€è¦è€ƒè™‘ä¸åŒçš„å›¢é˜Ÿã€ä¸åŒçš„äººå‘˜çš„éœ€æ±‚è¿›è¡Œå…¼å®¹åˆå¹¶

ç›®å‰ä¸ºä¹‹ï¼Œç»“åˆå¼€å‘ä»»ä½•åŠè‡ªèº«çš„å®é™…å·¥ä½œç»éªŒï¼Œæ€»ç»“å‡ºäº†ä¸¤ç§æ–‡æ¡£èšåˆçš„åœºæ™¯ï¼Œä¾›å¼€å‘è€…è¿›è¡Œä½¿ç”¨


- **æ‰‹åŠ¨é…ç½®èšåˆ(manual)**: å¼€å‘è€…æ‰‹åŠ¨é…ç½®ï¼Œçµæ´»é…ç½®å±•ç¤ºæ–‡æ¡£
    - ä¼˜ç‚¹ï¼šä½¿ç”¨ç®€å•ã€çµæ´»ï¼Œå­¦ä¹ æˆæœ¬ä½.è¯•é”™æˆæœ¬ä½
    - ç¼ºç‚¹ï¼šæœåŠ¡ä¼—å¤šæ—¶è¾ƒç¹çï¼Œæ— æ³•æ„ŸçŸ¥å­æœåŠ¡çš„ä¸Šä¸‹çº¿çŠ¶æ€
- **æœåŠ¡å‘ç°è‡ªåŠ¨èšåˆ(discover)**ï¼šåŸºäºæ³¨å†Œä¸­å¿ƒï¼Œä¸»åŠ¨èšåˆæœåŠ¡
    - ä¼˜ç‚¹ï¼šä½¿ç”¨åŠé…ç½®ç®€å•ã€å­¦ä¹ æˆæœ¬ä½.
    - ç¼ºç‚¹ï¼šæš‚æ—¶æ²¡æƒ³åˆ°ï¼Œæ¬¢è¿ä½ æ¥ä½“éªŒåé¦ˆ

### âœ… **3.4 å¯ä»¥åŒæ—¶èšåˆSwagger2ã€OpenAPI3ä¸¤ç§ä¸åŒçš„è§„èŒƒ**

æˆ‘ä»¬çš„é¡¹ç›®/äº§å“åœ¨é•¿æœŸè¿­ä»£å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ–è€…ä¸åŒçš„å›¢é˜Ÿé…åˆå¼€å‘ä¸­,æœ‰æ—¶å€™å­æœåŠ¡çš„æ ‡å‡†å¯èƒ½ä¸å°½ç»Ÿä¸€ã€‚è€Œæˆ‘ä»¬éœ€è¦ä¸€èµ·èšåˆæ€ä¹ˆåŠå‘¢?

å¥½åœ¨åœ¨Knife4jçš„å‰ç«¯Uiç»„ä»¶å·²ç»å®Œå…¨é€‚é…äº†Swagger2å’ŒOpenAPI3è§„èŒƒï¼Œåœ¨ç½‘å…³å±‚é¢ï¼Œæˆ‘ä»¬åªéœ€è¦æ ¹æ®è¯¥ç»„ä»¶æä¾›çš„æ‰‹åŠ¨é…ç½®ç­–ç•¥é…ç½®ä¸Šå°±è§£å†³äº†è¯¥é—®é¢˜ï¼Œå¯å‚è€ƒä¸‹é¢çš„æ–‡ç« ä»‹ç»ã€‚

### âœ… **3.5 çµæ´»é…ç½®èšåˆè§„åˆ™ï¼Œè‡ªå®šä¹‰æ’é™¤è§„åˆ™æ”¯æŒ**


çµæ´»é…ç½®æ˜¯knife4j-gatewayç»„ä»¶ä¸ºç½‘å…³èšåˆæœåŠ¡æä¾›çš„å¸¦åˆ€ä¾å«ï¼Œä¿éšœå¼€å‘è€…ä»¬åœ¨æ‰‹åŠ¨/æœåŠ¡å‘ç°ä¸¤å¤§åœºæ™¯ä¸‹é…åˆä½¿ç”¨ä»¥è¾¾åˆ°æœ€ç»ˆç›®çš„

ä»–ä¸»è¦æä¾›çš„æœåŠ¡åŒ…æ‹¬ï¼š

- è®¾å®šç½‘å…³å±‚é¢èšåˆçš„æ’é™¤è§„åˆ™ï¼Œæ”¯æŒæ­£åˆ™è¡¨è¾¾å¼æˆ–è€…å¼€å‘è€…æ ¹æ®SPIæ¥å£è‡ªå®šä¹‰å®ç°
> ä¾‹å¦‚æœ‰DubboæœåŠ¡çš„æ¥å£ï¼Œéœ€è¦åœ¨ç½‘å…³å±‚é¢è¿›è¡Œæ’é™¤ï¼Œç¦æ­¢èšåˆ
- å­æœåŠ¡çš„æœåŠ¡åç§°åˆ«åã€å±•ç¤ºé¡ºåºã€æ¥å£é¡ºåºç­‰é…ç½®è‡ªå®šä¹‰
- å­æœåŠ¡çš„è‡ªå®šä¹‰ContextPathè‡ªç”±çµæ´»é…ç½®ï¼Œæ»¡è¶³ä¸šåŠ¡éœ€è¦

1ã€åœ¨ç½‘å…³å±‚é¢ï¼Œæ’é™¤ä¸éœ€è¦çš„å­æœåŠ¡æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åŸºäºæ­£åˆ™è¡¨è¾¾å¼(è‡ª[4.3.0ç‰ˆæœ¬](/docs/changelog/x/4.3)è¿›è¡Œæ”¯æŒ)ï¼Œé…ç½®å¦‚ä¸‹ï¼š

```yaml

knife4j:
  gateway:
    enabled: true
    strategy: discover
    discover:
      version: swagger2
      enabled: true
      # æ’é™¤ä¸éœ€è¦èšåˆçš„å­æœåŠ¡ï¼ŒåŸºäºæ­£åˆ™è¡¨è¾¾å¼(æ”¯æŒå¤šä¸ª)
      excluded-services:
        # æ’é™¤orderå¼€å¤´çš„æœåŠ¡
        - order.*
        # æ’é™¤æœåŠ¡ä¸­åŒ…å«dubboå­—æ ·çš„æœåŠ¡
        - .*?dubbo.*
```

2ã€é…ç½®å­æœåŠ¡çš„åˆ«åï¼Œæ’åºï¼Œè‡ªå®šä¹‰é…ç½®å¦‚ä¸‹ï¼š
```yaml
knife4j:
  gateway:
    enabled: true
    strategy: discover
    discover:
      version: swagger2
      enabled: true
      excluded-services:
        - order.*
    # è‡ªå®šä¹‰é…ç½®å­æœåŠ¡çš„åˆ«åï¼Œæ’åºè§„åˆ™
      service-config:
        order-service:
          - group-name: è®¢å•æœåŠ¡
            order: 1
        user-service:
          - group-name: ç”¨æˆ·æœåŠ¡
            order: 2
```

3ã€ç½‘å…³æˆç»Ÿä¸€å¼€å¯é…ç½®å­æœåŠ¡çš„tagã€operationæ’åºè§„åˆ™

```yaml
knife4j:
  gateway:
    enabled: true
    strategy: discover
    discover:
      version: swagger2
      enabled: true
    # æ’åºè§„åˆ™
    tags-sorter: order
    operations-sorter: order
```




## ğŸ 4.èšç„¦ä¸¤å¤§ä½¿ç”¨åœºæ™¯(æ‰‹åŠ¨/æœåŠ¡å‘ç°è‡ªåŠ¨)èšåˆ

### **4.1 æ‰‹åŠ¨é…ç½®èšåˆ(manual)**

æ‰‹åŠ¨é…ç½®èšåˆï¼Œé¡¾åæ€ä¹‰,å¼€å‘è€…éœ€è¦è‡ªè¡Œå†™å­æœåŠ¡çš„è§„åˆ™æˆ–è€…è·¯å¾„,è¿™å’Œå¾®æœåŠ¡åœºæ™¯ä¸‹è‡ªåŠ¨å¤ç°èšåˆæ˜¯å½¢æˆäº’è¡¥æœºåˆ¶ï¼ŒåŒå‰‘åˆç’§å¨åŠ›ä¹‹ä¸‹ï¼Œå®Œæˆæœ€ç»ˆæˆæœè¾“å‡º

è¯¥åœºæ™¯è§£å†³ä¸åŒçš„é—®é¢˜ï¼ŒåŒ…æ‹¬ï¼š

- å­æœåŠ¡åŒæ—¶å­˜åœ¨Swagger2/OpenAPI3è§„èŒƒçš„æœåŠ¡
- å­æœåŠ¡å­˜åœ¨ä¸åŒçš„packageåŒ…åˆ†ç»„çš„çš„è§„èŒƒå®ä¾‹ï¼Œç”¨è¿‡springfoxæˆ–è€…springdocçš„å¼€å‘è€…åº”è¯¥æ¸…æ¥šå¯ä»¥æ ¹æ®packageåŒ…è·¯å¾„ã€pathè·¯ç”±åˆ›å»ºæ¥å£åˆ†ç»„

å¦‚ä¸‹å›¾ï¼š

![å›¾1.Spring Gatewayç½‘å…³èšåˆæ–‡æ¡£æµç¨‹ç¤ºæ„å›¾-æ‰‹åŠ¨é…ç½®](/images/blog/knife4j-gateway/knife4j-gateway-service.png)

è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºæ„å›¾ï¼Œæˆ‘ä»¬æœ‰ä¸‰ä¸ªæœåŠ¡ï¼š

- gateway-service:ç½‘å…³æœåŠ¡ï¼Œè´Ÿè´£ç½‘å…³è·¯ç”±é‰´æƒã€è·¯ç”±è½¬å‘
- order-service:å­æœåŠ¡ä¹‹ä¸€ï¼ŒåŸºäºOpenAPI3è§„èŒƒæš´éœ²è§„èŒƒåœ°å€:`/v3/api-docs`
- user-service: å­æœåŠ¡ä¹‹ä¸€ï¼ŒåŸºäºSwagger2è§„èŒƒæš´éœ²è§„èŒƒåœ°å€ï¼š`/v2/api-docs`

æˆ‘ä»¬ä»æœåŠ¡æ¶æ„æµç¨‹å›¾ä¸­äº†è§£åˆ°äº†æˆ‘ä»¬éœ€è¦çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆåœ¨`gateway-service`ç»„ä»¶ä¸­ï¼Œå°±å¯ä»¥ä½¿ç”¨`knife4j-gateway`ç»„ä»¶æä¾›çš„æ‰‹åŠ¨é…ç½®èšåˆï¼Œå°†æ–‡æ¡£è¿›è¡Œèšåˆå±•ç¤º

ç®€å•çš„é…ç½®å¦‚ä¸‹ï¼š

```yaml
knife4j:
  gateway:
    enabled: true
    # é€‰æ‹©æ‰‹åŠ¨
    strategy: manual
    routes:
      - name: ç”¨æˆ·æœåŠ¡
        service-name: user-service
        url: /user/v2/api-docs
      - name: è®¢å•æœåŠ¡
        service-name: order-service
        url: /order/v3/api-docs
```

### **4.2 æœåŠ¡å‘ç°è‡ªåŠ¨èšåˆ(discover)**

æ‰‹åŠ¨èšåˆçš„å”¯ä¸€é—®é¢˜å°±æ˜¯ï¼Œä¸€æ—¦æˆ‘ä»¬çš„äº§å“/é¡¹ç›®ï¼Œå­æœåŠ¡æ•°é‡ä¼—å¤šï¼Œçº¯é æ‰‹åŠ¨å»é…ï¼Œé‚£å¯¹äºå¼€å‘è€…æ¥è¯´ä¹Ÿæ˜¯æå…¶ç—›è‹¦çš„ï¼Œå°±å¥½åƒæ˜¯ä¾®è¾±å¼€å‘è€…ä¸€æ ·ã€‚ã€‚

**æˆ‘éƒ½èƒ½å†™ä»£ç äº†ï¼Œä½ è¿˜è®©æˆ‘å†™è¿™ä¹ˆå¤šç¹æ‚çš„é…ç½®ï¼Œé‚£æ˜¯å¯¹ç¨‹åºå‘˜çš„ä¸å°Šé‡ã€‚**

åŸºäºæœåŠ¡å‘ç°è‡ªåŠ¨èšåˆçš„éœ€æ±‚åœºæ™¯ï¼Œå°±ç”±æ­¤è¯ç”Ÿ.

> åœ¨ä¸Šé¢æˆ‘ä»¬ä»‹ç»knife4j-gatewayç‰¹ç‚¹æ—¶ï¼Œæˆ‘ä»¬æåˆ°è¯¥ç»„ä»¶è§£è€¦ï¼Œèšç„¦æ–‡æ¡£èšåˆåŠŸèƒ½ï¼ŒèŒè´£å•ä¸€ï¼Œè¿™é‡Œå¾—ä»¥ä½“ç°

å¯¹äºæœåŠ¡å‘ç°åœºæ™¯ä¸‹çš„è‡ªåŠ¨èšåˆï¼Œé…ç½®å°±æ›´ç®€å•äº†ï¼Œä½†å¯¹æˆ‘ä»¬ä¹Ÿæœ‰ä¸€äº›å°å°çš„çº¦æŸ
> âš ï¸ æˆ‘ä»¬çš„å­æœåŠ¡è§„èŒƒå®ç°éœ€è¦ç»Ÿä¸€ï¼Œè¦ä¹ˆå…¨éƒ¨ç”¨Swagger2è§„èŒƒï¼Œæˆ–è€…OpenAPI3è§„èŒƒ

é…ç½®å¦‚ä¸‹ï¼š
```yaml
knife4j:
  gateway:
    # â‘  ç¬¬ä¸€ä¸ªé…ç½®ï¼Œå¼€å¯gatewayèšåˆç»„ä»¶
    enabled: true
    # â‘¡ ç¬¬äºŒè¡Œé…ç½®ï¼Œè®¾ç½®èšåˆæ¨¡å¼é‡‡ç”¨discoveræœåŠ¡å‘ç°çš„æ¨¡å¼
    strategy: discover
    discover:
      # â‘¢ ç¬¬ä¸‰è¡Œé…ç½®ï¼Œå¼€å¯discoveræ¨¡å¼
      enabled: true
      # â‘£ ç¬¬å››è¡Œé…ç½®ï¼Œèšåˆå­æœåŠ¡å…¨éƒ¨ä¸ºSwagger2è§„èŒƒçš„æ–‡æ¡£
      version: swagger2

```

è¿™ä¸ªç‰¹ç‚¹å’Œæˆ‘ä»¬å‰é¢æåˆ°çš„ä½¿ç”¨ç®€ç­”è¿™ä¸€æ¡åˆå¯¹ä¸Šäº†ï¼ŒçœŸçš„åªæœ‰ä¸‰å››è¡Œé…ç½®ã€‚

ä½†æ˜¯åœ¨å¾®æœåŠ¡èšåˆåœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬è™½ç„¶å°è£…å†…éƒ¨å®ç°ï¼Œä¹Ÿæœ‰å¿…è¦å’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹ï¼Œå…·ä½“çš„å¤„ç†è§„åˆ™åŸç†

å…ˆæ¥çœ‹ä¸€å¼ ç®€å•çš„æ¶æ„å›¾-æœåŠ¡å‘ç°çš„åœºæ™¯ï¼Œå¦‚ä¸‹å›¾ï¼š


![å›¾2.Spring Gatewayç½‘å…³èšåˆæ–‡æ¡£æµç¨‹ç¤ºæ„å›¾-æœåŠ¡å‘ç°](/images/blog/knife4j-gateway/knife4j-gateway-service3.png)


åœ¨æœåŠ¡å‘ç°çš„åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬ä¾èµ–æ³¨å†Œä¸­å¿ƒç»„ä»¶ï¼Œè¿™é‡Œä»¥Nacosä¸ºä¾‹ï¼Œä½†æˆ‘ä»¬å°†ç½‘å…³æœåŠ¡`gateway-service`ä¹Ÿæ³¨å†Œåˆ°Nacosä¸­æ—¶

æœ¬èº«åŸºäºSpring Cloudå¾®æœåŠ¡ä½“ç³»çš„`DiscoverClient.java`æ¥å£ï¼Œåœ¨Nacosç»„ä»¶å®ä¾‹ä¸‹ï¼Œä¼šä¸ºæˆ‘ä»¬è§£å†³å„ä¸ªå­æœåŠ¡æ³¨å†Œä¸Šæ¥çš„æœåŠ¡å‘ç°é—®é¢˜ï¼ŒåŒ…æ‹¬å­æœåŠ¡å®ä¾‹å¯¹è±¡ï¼Œæ˜¯å¦ä¸Šçº¿ã€å¿ƒè·³æ£€æµ‹ç­‰ç­‰

è€Œæˆ‘ä»¬ä¾èµ–Springä½“ç³»æä¾›çš„`ApplicationEvent`äº‹ä»¶ç›‘å¬ä½“ç³»ï¼Œå°±å¯ä»¥ä»ç»Ÿä¸€çš„`DiscoverClient`ä½“ç³»ä¸‹ï¼Œå®ç°æˆ‘ä»¬çš„è‡ªåŠ¨èšåˆåœºæ™¯ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯ä¸ç”¨å…³å¿ƒå„ä¸ªæ³¨å†Œä¸­å¿ƒçš„å·®å¼‚ï¼Œåœ¨Spring Cloudçš„å¾®æœåŠ¡ä½“ç³»ä¸‹ï¼Œæ³¨å†Œä¸­å¿ƒéœ€è¦éµå¾ª`DiscoverClient`æ¥å£è¿›è¡Œæ ‡å‡†å®ç°ã€‚

åœ¨`knife4j-gateway`çš„æœåŠ¡å‘ç°åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬é€šè¿‡`@EventListener`å®ç°å¯¹å¾®æœåŠ¡åœºæ™¯ä¸‹çš„äº‹ä»¶ç›‘å¬ï¼Œä»¥å¡«å……ç½‘å…³æˆæ–‡æ¡£çš„æ•°æ®å®ç°

ç›‘å¬äº‹ä»¶å›è°ƒå¤„ç†æºç å¦‚ä¸‹ï¼š
```javascript
@Slf4j
@AllArgsConstructor
public class ServiceChangeListener {
    
    final DiscoveryClient discoveryClient;
    final ServiceDiscoverHandler serviceDiscoverHandler;
    final Knife4jGatewayProperties knife4jGatewayProperties;
    
    @EventListener(classes = {ApplicationReadyEvent.class, HeartbeatEvent.class, RefreshRoutesEvent.class})
    public void discover() {
        log.debug("discover service.");
        List<String> services = discoveryClient.getServices();
        if (Objects.equals(knife4jGatewayProperties.getStrategy(), GatewayStrategy.DISCOVER)) {
            this.serviceDiscoverHandler.discover(services);
        }
    }
}
```

é€šè¿‡æ³¨å†Œä¸­å¿ƒåœ¨`DiscoverClient`ä½“ç³»ä¸‹çš„å®ç°ï¼ŒåŒ…æ‹¬`è°ƒåº¦(Scheduler)`ã€`å¿ƒè·³æ£€æµ‹(HeartBeat)`ã€`äº‹ä»¶å›è°ƒ(ApplicationEvent)`ç­‰æœºåˆ¶ï¼Œå®ç°å¾®æœåŠ¡ç½‘å…³å±‚é¢æ–‡æ¡£çš„è‡ªåŠ¨èšåˆã€‚


## ğŸ® 5.æœåŠ¡å‘ç°çš„è·¯ç”±èšåˆç­–ç•¥-æ•°æ®æ¥æº

åœ¨ä¸Šé¢ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»ä½¿ç”¨ç‰¹ç‚¹ã€ä¸¤å¤§åœºæ™¯(æ‰‹åŠ¨/æœåŠ¡å‘ç°)ç­‰å…¨é¢ä»‹ç»äº†knife4j-gatewayç»„ä»¶ï¼Œåœ¨æ–‡æœ«ï¼Œè¿˜æ˜¯æœ‰å¿…è¦å’Œå¤§å®¶è®²è®²è¯¥ç»„ä»¶åœ¨`discover`æœåŠ¡å‘ç°æ¨¡å¼ä¸‹ï¼Œå­æœåŠ¡çš„æ˜¯æ•°æ®æ¥æºå¤„ç†è§„åˆ™


ä¸»è¦æ˜¯4ä¸ªæ–¹é¢ï¼ŒåŒ…æ‹¬ï¼š

- åŸºäºSpring Cloud Gatewayé…ç½®çš„routesè§„åˆ™è§£æå­æœåŠ¡è·¯ç”±ï¼Œæ•°æ®æ¥æºï¼š`spring.cloud.gateway.routes`
- åœ¨discoveræœåŠ¡å‘ç°åœºæ™¯ä¸‹ï¼Œé’ˆå¯¹è‡ªå®šä¹‰æ·»åŠ çš„routesï¼Œé»˜è®¤å†æ¬¡è¿½åŠ ï¼Œæ•°æ®æ¥æºï¼š`knife4j.gateway.routes`
- æœåŠ¡å‘ç°discoveræ¨¡å¼ä¸‹ï¼Œå¼€å‘è€…åœ¨ç½‘å…³æˆçš„è·¯ç”±è½¬å‘æ¨¡å¼é»˜è®¤é€šè¿‡DiscoveryClientçš„é»˜è®¤æ–¹å¼è½¬å‘è·¯ç”±ï¼Œè§„åˆ™æ˜¯`pattern:/service-id/**`
- æ¥æ”¶ç¼–ç æ–¹å¼åŠ¨æ€æ³¨å…¥Spring Cloud Gatewayç½‘å…³çš„è·¯ç”±ï¼Œè¿›è¡Œèšåˆè½¬å‘

### 5.1 æ‰‹åŠ¨é…ç½®-è‡ªå®šä¹‰Routes

è‡ªå®šä¹‰Routesä¸»è¦æ˜¯å¼€å‘è€…æ ¹æ®`Knife4j-gateway`ç»„ä»¶æä¾›çš„å¼€å‘é…ç½®ï¼Œåœ¨è¿›è¡Œæ‰‹åŠ¨èšåˆæ—¶ï¼Œå¡«å†™çš„é…ç½®ï¼Œè¿™éƒ¨åˆ†çš„é…ç½®æ˜¯ç½‘å…³èšåˆçš„æ•°æ®æ¥æºä¹‹ä¸€

è€Œé…ç½®å†…å®¹`knife4j-gateway`ç»„ä»¶ä¸ä¼šåšä»»ä½•å¤„ç†,å¼€å‘è€…é…ç½®ä»€ä¹ˆå°±å±•ç¤ºä»€ä¹ˆ

ç¤ºä¾‹é…ç½®å¦‚ä¸‹ï¼š
```yaml
knife4j:
  gateway:
    enabled: true
    # é€‰æ‹©æ‰‹åŠ¨
    strategy: manual
    routes:
      - name: ç”¨æˆ·æœåŠ¡
        service-name: user-service
        url: /user/v2/api-docs
```

### 5.2 DiscoverClientè‡ªåŠ¨å‘ç°

å¦‚æœå¼€å‘è€…åœ¨Spring Cloud Gatewayç½‘å…³ç»„ä»¶ä¸‹æ²¡æœ‰é…ç½®å­æœåŠ¡çš„è½¬å‘è·¯ç”±è§„åˆ™ï¼Œå®Œå…¨ä¾é é»˜è®¤çš„è½¬å‘è§„åˆ™(`pattern:/service-id/**`)ï¼Œå…¶å®å°±æ˜¯æ ¹æ®å­æœåŠ¡åç§°è¿›è¡Œè½¬å‘

åœ¨è¿™ç§è§„åˆ™ä¸‹ï¼Œknife4j-gatewayç»„ä»¶ä¼šè¯»å–`DiscoverClient`ç»„ä»¶ä¸‹æ³¨å…¥çš„`DiscoveryClientRouteDefinitionLocator`è·¯ç”±åˆ—è¡¨è¿›è¡Œè§£æ

åœ¨Spring Cloud Gatewayç½‘å…³çš„é…ç½®ï¼Œå¼€å¯è¯¥è§„åˆ™ï¼Œé…ç½®å¦‚ä¸‹ï¼š

```yaml
spring:
    # è·¯ç”±ç½‘å…³é…ç½®
    gateway:
      # å¯ç”¨äº†è‡ªåŠ¨æ ¹æ®æœåŠ¡åå»ºç«‹è·¯ç”±
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
```

è€Œ`knife4j-gateway`ç»„ä»¶ä¸­ï¼Œå°±æ˜¯ç›´æ¥è·å–è¯¥æ¨¡å¼ä¸‹çš„å­æœåŠ¡åˆ—è¡¨è½¬å‘è§„åˆ™ï¼Œæ³¨å…¥åˆ°`knife4j-gateway`ç»„ä»¶ä¸‹çš„æ•°æ®æºï¼Œä½œä¸ºuiå±‚é¢çš„è½¬å‘ä¾æ®

éƒ¨åˆ†æºç è§£æå¦‚ä¸‹:

```javascript
public class DiscoverClientRouteServiceConvert extends AbstactServiceRouterConvert {
    
    final DiscoveryClientRouteDefinitionLocator discoveryClientRouteDefinitionLocator;
    final Knife4jGatewayProperties knife4jGatewayProperties;
    @Override
    public void process(ServiceRouterHolder holder) {
        log.debug("Spring Cloud Gateway DiscoverClient process.");
        // å–é»˜è®¤å­æœåŠ¡çš„è·¯å¾„è§„åˆ™
        discoveryClientRouteDefinitionLocator.getRouteDefinitions()
                .filter(routeDefinition -> ServiceUtils.startLoadBalance(routeDefinition.getUri()))
                .filter(routeDefinition -> ServiceUtils.includeService(routeDefinition.getUri(), holder.getService(), holder.getExcludeService()))
                .subscribe(routeDefinition -> parseRouteDefinition(holder, this.knife4jGatewayProperties.getDiscover(), routeDefinition.getPredicates(), routeDefinition.getUri().getHost(),
                        routeDefinition.getUri().getHost()));
    }
    //others...
}

```

### 5.3 Spring Gatewayç½‘å…³Routesé…ç½®

è¯¥é…ç½®å±æ€§å’Œè‡ªå®šä¹‰é…ç½®knife4j-gatewayç»„ä»¶çš„routesä¸€æ ·ï¼Œå¼€å‘è€…ä¸€èˆ¬ä¼šè‡ªå®šä¹‰é…ç½®å­æœåŠ¡çš„è·¯ç”±è½¬å‘ç­–ç•¥ï¼Œé€šè¿‡`spring.cloud.gateway.routes`è¿›è¡Œé…ç½®

è€Œ`knife4j-gateway`ä¼šè·å–è¯¥éƒ¨åˆ†çš„æ•°æ®æºï¼Œé€šè¿‡è¯»å–å­æœåŠ¡é…ç½®çš„`Predicate`æ¥è·å–å­æœåŠ¡çš„`Path`å‰ç¼€ContextPathè§„åˆ™è¿›è¡Œèšåˆ

### 5.4 åŠ¨æ€è·¯ç”±æ³¨å†Œé…ç½®

åŠ¨æ€è·¯ç”±æ³¨å†Œå¯èƒ½åœ¨æŸäº›ç‰¹æ®Šçš„åœºæ™¯ä¸‹ä¹Ÿæœ‰éœ€æ±‚ï¼Œå› æ­¤`knife4j-gateway`ä¹Ÿä¼šæŠŠåŠ¨æ€æ³¨å…¥è¿›æ¥çš„è·¯ç”±è¿›è¡Œèšåˆï¼Œä½œä¸ºæ–‡æ¡£æ•°æ®æºè¿›è¡Œå±•ç¤º

åŠ¨æ€æ•°æ®æºæ¥æºäº`RouteDefinitionRepository`å¯¹è±¡

## 6.ğŸ‘» æ€»ç»“


å¥½äº†ï¼Œæœ¬æ–‡ä»‹ç»åˆ°è¿™é‡Œä¹ŸåŸºæœ¬æ¶µç›–äº†knife4j-gatewayç½‘å…³èšåˆç»„ä»¶çš„æ–¹æ–¹é¢é¢ï¼Œå¸Œæœ›è¯¥ç»„ä»¶èƒ½ç»™ä½ å¸¦æ¥å¸®åŠ©~~!


æ‚¨æœ‰æ›´å¤šçš„æƒ³æ³•æˆ–è€…å»ºè®®ï¼Œå¯ä»¥å…³æ³¨å…¬ä¼—å·"Knife4j"ï¼Œå‚ä¸Knife4jçš„äº¤æµç¾¤è¿›è¡Œæ²Ÿé€šåé¦ˆï¼Œè°¢è°¢

![å›¾5.Knife4jå¾®ä¿¡å…¬ä¼—å·](/images/website/qrcode2.png)
